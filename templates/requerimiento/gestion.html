{% extends 'componentes/formulario.html' %}
{% load widget_tweaks %} {# Para usar el filtro add_class #}

{% block title %}
    {% if modo == 'crear' %}Crear Requerimiento (TDR){% else %}Editar Requerimiento (TDR){% endif %}
{% endblock %}

{% block content %}
    <h1 class="mb-4 text-center text-md-start crud-title">
        {% if modo == 'crear' %}Registrar Nuevo Requerimiento (TDR){% else %}Editar Requerimiento (TDR) #{{ requerimiento.id }}{% endif %}
    </h1>

    {# Contenedor para mensajes, estilizado para un mejor efecto visual #}
    {% if messages %}
        <div class="alert-container mb-4">
            <ul class="messages list-unstyled mb-0">
                {% for message in messages %}
                    <li{% if message.tags %} class="{{ message.tags }} alert alert-dismissible fade show rounded-3 shadow-sm"{% endif %} role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}

    <form method="post" id="requerimientoForm" class="p-3 p-md-4 bg-white rounded-lg shadow-sm">
        {% csrf_token %}
        {{ form.media }}

        {# Campos del formulario principal de Requerimiento #}
        <div class="card mb-5 shadow-lg border-0 rounded-4">
            <div class="card-header bg-success-subtle text-success fw-bold py-3 rounded-top-4">
                <h4 class="mb-0 text-dark-emphasis">Información del Requerimiento</h4>
            </div>
            <div class="card-body p-4">
                <div class="row g-3">
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.vehiculo.id_for_label }}" class="form-label fw-bold text-secondary-emphasis">{{ form.vehiculo.label }}</label>
                        {{ form.vehiculo}}
                        {% if form.vehiculo.errors %}<ul class="errorlist text-danger small mt-1">{% for error in form.vehiculo.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.informe_tecnico_nro.id_for_label }}" class="form-label fw-bold text-secondary-emphasis">
                            {{ form.informe_tecnico_nro.label }}</label>
                        {{ form.informe_tecnico_nro }}
                        {% if form.informe_tecnico_nro.errors %}<ul class="errorlist text-danger small mt-1">{% for error in form.informe_tecnico_nro.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
                    </div>
                </div>
            </div>
        </div>

        <hr class="my-5 border-2 border-primary opacity-50">

        {# Sección para Servicios Propuestos (RequerimientoDescripcionDetalleFormSet) #}
        <div class="card mb-5 shadow-lg border-0 rounded-4">
            <div class="card-header bg-info-subtle text-info fw-bold py-3 d-flex justify-content-between align-items-center rounded-top-4">
                <h4 class="mb-0 text-dark-emphasis">Servicios Propuestos</h4>
                <button type="button" class="btn btn-success btn-sm animated-button-pulse" id="add-requerimiento-servicio">
                    <i class="bi bi-plus-circle me-2"></i>Agregar Servicio
                </button>
            </div>
            <div class="card-body p-4">
                <div id="requerimiento-servicios-formset">
                    {{ servicio_detalle_formset.management_form }}
                    {% for formset_form in servicio_detalle_formset %}
                        <div class="formset-row row g-2 mb-3 align-items-center p-3 border rounded-3 bg-light-subtle animated-fade-in">
                            {% for hidden_field in formset_form.hidden_fields %}
                                {{ hidden_field }}
                            {% endfor %}
                            <div class="col-md-10">
                                {# ¡CORREGIDO!: Ahora renderiza el campo descripcion_propuesta directamente #}
                                <label for="{{ formset_form.descripcion_propuesta.id_for_label }}"
                                    class="form-label visually-hidden">Descripción</label>
                                {{ formset_form.descripcion_propuesta }}
                                {% if formset_form.descripcion_propuesta.errors %}<ul class="errorlist text-danger small mt-1">{% for error in formset_form.descripcion_propuesta.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
                            </div>
                            <div class="col-md-2 text-end">
                                {% if formset_form.instance.pk %}
                                    <div class="form-check form-switch d-inline-block me-2">
                                        {{ formset_form.DELETE }}
                                        <label class="form-check-label text-muted"
                                            for="{{ formset_form.DELETE.id_for_label }}">Eliminar</label>
                                    </div>
                                {% else %}
                                    <button type="button" class="btn btn-danger btn-sm remove-formset-row animated-button-delete" title="Eliminar fila"><i
                                            class="bi bi-x-lg"></i></button>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <hr class="my-5 border-2 border-primary opacity-50">

        {# Sección para Piezas Propuestas (RequerimientoPiezaDetalleFormSet) #}
        <div class="card mb-5 shadow-lg border-0 rounded-4">
            <div class="card-header bg-warning-subtle text-warning fw-bold py-3 d-flex justify-content-between align-items-center rounded-top-4">
                <h4 class="mb-0 text-dark-emphasis">Piezas Propuestas</h4>
                <button type="button" class="btn btn-success btn-sm animated-button-pulse" id="add-requerimiento-pieza">
                    <i class="bi bi-plus-circle me-2"></i>Agregar Pieza
                </button>
            </div>
            <div class="card-body p-4">
                <div id="requerimiento-piezas-formset">
                    {{ pieza_detalle_formset.management_form }}
                    {% for formset_form in pieza_detalle_formset %}
                        <div class="formset-row row g-2 mb-3 align-items-center p-3 border rounded-3 bg-light-subtle animated-fade-in">
                            {% for hidden_field in formset_form.hidden_fields %}
                                {{ hidden_field }}
                            {% endfor %}
                            <div class="col-md-6">
                                <label for="{{ formset_form.pieza.id_for_label }}"
                                    class="form-label visually-hidden">Pieza</label>
                                {{ formset_form.pieza}}
                                {% if formset_form.pieza.errors %}<ul class="errorlist text-danger small mt-1">{% for error in formset_form.pieza.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
                            </div>
                            <div class="col-md-4">
                                <label for="{{ formset_form.cantidad.id_for_label }}"
                                    class="form-label visually-hidden">Cantidad</label>
                                {{ formset_form.cantidad }}
                                {% if formset_form.cantidad.errors %}<ul class="errorlist text-danger small mt-1">
                                    {% for error in formset_form.cantidad.errors %}
                                    <li>{{ error }}</li>
                                    {% endfor %}
                                </ul>
                                {% endif %}
                            </div>
                            <div class="col-md-2 text-end">
                                {% if formset_form.instance.pk %}
                                    <div class="form-check form-switch d-inline-block me-2">
                                        {{ formset_form.DELETE }}
                                        <label class="form-check-label text-muted"
                                            for="{{ formset_form.DELETE.id_for_label }}">Eliminar</label>
                                    </div>
                                {% else %}
                                    <button type="button" class="btn btn-danger btn-sm remove-formset-row animated-button-delete" title="Eliminar fila"><i
                                            class="bi bi-x-lg"></i></button>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        {# Botones de acción al final del formulario #}
        <div class="d-flex justify-content-end gap-3 mt-5">
            <button type="submit" class="btn btn-primary btn-lg animated-button-primary shadow-sm"><i class="bi bi-save me-2"></i>Guardar
                Requerimiento</button>
            <a href="{% url 'lista_requerimientos' %}" class="btn btn-secondary btn-lg animated-button-secondary shadow-sm"><i
                    class="bi bi-x-circle me-2"></i>Cancelar</a>
        </div>
    </form>
{% endblock %}

{% block extra_js %}
    {# Incluye jQuery y Select2 desde CDN - necesarios para el JS de Piezas #}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // URLs de la API de Django que se pasan a las funciones JS en base.js
            const urls = {
                buscarPiezas: "{% url 'buscar_piezas_api' %}",
                csrfToken: '{{ csrf_token }}'
            };

            // Inicializar Select2 para el campo de Vehículo (si lo usas con Select2)
            const vehiculoSelect = $('#id_vehiculo');
            if (vehiculoSelect.length && !vehiculoSelect.hasClass('select2-hidden-accessible')) {
                vehiculoSelect.select2();
            }

            // Inicializar Select2 para los campos de Pieza existentes al cargar la página
            document.querySelectorAll('select[name$="-pieza"]').forEach(select => {
                window.initializeSelect2Pieza(select, urls.buscarPiezas);
            });

            // Leer los prefijos dinámicos generados por Django para los formsets
            // Estos son los 'related_name' en minúsculas del ForeignKey o el nombre del modelo
            // relacionado en minúsculas seguido de '_set'
            const servicioFormsetPrefix = '{{ servicio_detalle_formset.prefix }}'; // Acceder al prefijo real
            const piezaFormsetPrefix = '{{ pieza_detalle_formset.prefix }}'; // Acceder al prefijo real
            
            // Configurar los formsets, llamando a la función global de base.js
            // Para el formset de servicios, ya no hay Select2, así que pasamos null para el callback
            window.setupFormset('requerimiento-servicios-formset', 'add-requerimiento-servicio', 'empty-requerimiento-servicio-form', servicioFormsetPrefix, null, null, null, null);
            // Para el formset de piezas, sí se usa Select2
            window.setupFormset('requerimiento-piezas-formset', 'add-requerimiento-pieza', 'empty-requerimiento-pieza-form', piezaFormsetPrefix, window.initializeSelect2Pieza, urls.buscarPiezas);
        });
    </script>

    {# Plantilla vacía para nuevas filas de RequerimientoDescripcionDetalle #}
    {# '__prefix__' es un placeholder que Django reemplaza con el índice de la fila #}
    <template id="empty-requerimiento-servicio-form">
        <div class="col-md-10">
            {# ¡CORREGIDO!: Template para el campo descripcion_propuesta como textarea #}
            <label for="id_serviciodetalle-__prefix__-descripcion_propuesta"
                class="form-label visually-hidden">Descripción</label>
            <textarea name="serviciodetalle-__prefix__-descripcion_propuesta"
                id="id_serviciodetalle-__prefix__-descripcion_propuesta" class="form-control"
                placeholder="Escribe la descripción del servicio propuesto..." rows="2"></textarea>
        </div>
        <div class="col-md-2 text-end">
            <button type="button" class="btn btn-danger btn-sm remove-formset-row animated-button-delete" title="Eliminar fila"><i
                    class="bi bi-x-lg"></i></button>
        </div>
    </template>

    {# Plantilla vacía para nuevas filas de RequerimientoPiezaDetalle #}
    <template id="empty-requerimiento-pieza-form">
        <div class="col-md-6">
            <label for="id_piezadetalle-__prefix__-pieza" class="form-label visually-hidden">Pieza</label>
            <select name="piezadetalle-__prefix__-pieza" id="id_piezadetalle-__prefix__-pieza" class="form-select"></select>
        </div>
        <div class="col-md-4">
            <label for="id_piezadetalle-__prefix__-cantidad" class="form-label visually-hidden">Cantidad</label>
            <input type="number" name="piezadetalle-__prefix__-cantidad" id="id_piezadetalle-__prefix__-cantidad"
                class="form-control" placeholder="Cantidad" min="1">
        </div>
        <div class="col-md-2 text-end">
            <button type="button" class="btn btn-danger btn-sm remove-formset-row animated-button-delete" title="Eliminar fila"><i
                    class="bi bi-x-lg"></i></button>
        </div>
    </template>
{% endblock %}
