{% extends "componentes/formulario.html" %}

{% block title %}
{% if modo == 'editar' %}
Editar Servicio
{% else %}
Crear Servicio
{% endif %}{% endblock title %}


{% block formtit %} Crear Servicio {% endblock formtit %}


{% block formulario %}
{% csrf_token %}
{{ form.media }}



<div class="container">
    <div class="row">
        <div class="col-md-4 mb-3">
            {{ form.vehiculo.label_tag }}
            {{ form.vehiculo }}
        </div>
        <div class="col-md-4 mb-3">
            {{ form.persona.label_tag }}
            {{ form.persona }}
        </div>
        <div class="col-md-4 mb-3">
            {{ form.tecnico.label_tag }}
            {{ form.tecnico }}
        </div>
    </div>
    <input type="hidden" id="id_kilometraje_vehiculo" name="kilometraje_vehiculo" value="0">
    <div class="row">
        <div class="col-md-6 mb-3">
            {{ form.kilometraje_act.label_tag }}
            {{ form.kilometraje_act }}
        </div>
        <div class="col-md-6 mb-3">
            {{ form.kilometraje_diff.label_tag }}
            {{ form.kilometraje_diff }}
        </div>
    </div>
    <div class="mb-3">
        {{ form.descripcion.label_tag }}
        {{ form.descripcion }}
    </div>

    <h5 class="mt-4">Piezas a Utilizar</h5>
    {{ formset.management_form }}
    <div class="table-responsive">
        <table class="table align-middle" id="movimientos-table">
            <thead>
                <tr>
                    <th>Pieza</th>
                    <th>Cantidad</th>
                    <th>Eliminar</th>
                </tr>
            </thead>
            <tbody>
                {% for f in formset %}
                <tr>
                    <td class="align-middle">{{ f.pieza }}</td>
                    <td class="align-middle">{{ f.cantidad }}</td>
                    <td class="align-middle">
                        {% if formset.can_delete %}
                        {{ f.DELETE }} <button type="button" class="btn btn-danger btn-sm remove-row">X</button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
                <!-- Fila plantilla oculta para agregar dinámicamente -->
                <tr id="empty-form-row" style="display:none;">
                    <td class="align-middle">{{ formset.empty_form.pieza }}</td>
                    <td class="align-middle">{{ formset.empty_form.cantidad }}</td>
                    <td class="align-middle">
                        {% if formset.can_delete %}
                        {{ formset.empty_form.DELETE }} <button type="button"
                            class="btn btn-danger btn-sm remove-row">X</button>
                        {% endif %}
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    <a href="#" id="add-movimiento-btn" class="btn btn-link">+ Agregar pieza</a>
    <div class="mt-4">
        <button class="btn btn-success" type="submit">Guardar</button>
        <a class="btn btn-danger" href="{% url 'servicio_lista' %}">Cancelar</a>
    </div>
</div>
{% endblock formulario %}


{% block script %}
<script>
    $(document).ready(function () {
        // --- Cálculo de kilometraje ---
        function calcularDiferencia() {
            const kmAnterior = parseFloat($('#id_kilometraje_vehiculo').val()) || 0;
            const kmActual = parseFloat($('#id_kilometraje_act').val()) || 0;
            const diff = kmActual - kmAnterior;
            $('#id_kilometraje_diff').val(diff >= 0 ? diff : 0);
        }
        $('#id_kilometraje_act').on('input', calcularDiferencia);
        $('#id_vehiculo').on('change', function () {
            const vehiculoId = $(this).val();
            if (vehiculoId) {
                fetch(`/vehiculos/kilometraje/${vehiculoId}/`)
                    .then(response => response.json())
                    .then(data => {
                        $('#id_kilometraje_vehiculo').val(data.kilometraje);
                        calcularDiferencia();
                    });
            } else {
                $('#id_kilometraje_vehiculo').val(0);
                calcularDiferencia();
            }
        });
        if ($('#id_vehiculo').val()) {
            $('#id_vehiculo').trigger('change');
        }

        // --- Agregar piezas dinámicamente usando la plantilla ---
        const addBtn = $('#add-movimiento-btn');
        const table = $('#movimientos-table tbody');
        const totalForms = $('#id_movimientostock_set-TOTAL_FORMS');
        const emptyRow = $('#empty-form-row');

        addBtn.on('click', function (e) {
            e.preventDefault();
            const currentForms = parseInt(totalForms.val());
            let newRowHtml = emptyRow.html().replace(/__prefix__/g, currentForms);
            let newRow = $('<tr>' + newRowHtml + '</tr>');
            // Re-inicializar select2/DAL para el nuevo select
            newRow.find('select.django-autocomplete-light-widget').each(function () {
                $(this).removeAttr('data-select2-id');
                $(this).select2({ width: 'style' });
            });
            table.append(newRow);
            console.log(currentForms)
            totalForms.val(currentForms + 1);
        });

        // Eliminar fila (solo cuenta filas visibles, excluye la plantilla oculta)
        table.on('click', '.remove-row', function () {
            const visibleRows = table.find('tr').not('#empty-form-row');
            if (visibleRows.length > 1) { // deja al menos una fila visible
                $(this).closest('tr').remove();
                totalForms.val(visibleRows.length - 1);
            }
        });
    });
</script>
{% endblock script %}